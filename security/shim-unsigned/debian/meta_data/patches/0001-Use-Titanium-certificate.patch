From 7fc985a350f9f7f5abbd19cef7a1947a3e33e5c8 Mon Sep 17 00:00:00 2001
From: root <root@yow-cgts4-lx.wrs.com>
Date: Mon, 15 Jan 2018 13:25:04 -0500
Subject: [PATCH] Use Titanium certificate

Signed-off-by: Scott Little <scott.little@windriver.com>
---
 Make.defaults |  6 ++++++
 Makefile      | 29 ++++++++++++++++-------------
 2 files changed, 22 insertions(+), 13 deletions(-)

diff --git a/Make.defaults b/Make.defaults
index e11ab5a..d16510c 100644
--- a/Make.defaults
+++ b/Make.defaults
@@ -40,6 +40,12 @@ CLANG_BUGS	= $(if $(findstring gcc,$(CC)
 
 COMMIT_ID ?= $(shell if [ -e .git ] ; then git log -1 --pretty=format:%H ; elif [ -f commit ]; then cat commit ; else echo master; fi)
 
+# We compile a certificate into shim.  Usually this is a one-time generated
+# certificate (make-certs script) however we want to include a custom
+# certificate for which we have the key.  We use the key to sign the kernel and
+# grub down the road
+INTERNAL_CERT = tis-shim
+
 ifeq ($(ARCH),x86_64)
 	ARCH_CFLAGS		?= -mno-mmx -mno-sse -mno-red-zone -nostdinc \
 				   $(CLANG_BUGS) -m64 \
diff --git a/Makefile b/Makefile
index 115e7f0..f2b37fa 100644
--- a/Makefile
+++ b/Makefile
@@ -32,9 +32,10 @@ TARGETS	+= $(MMNAME).signed $(FBNAME).si
 CFLAGS += -DENABLE_SHIM_CERT
 else
 TARGETS += $(MMNAME) $(FBNAME)
+CFLAGS += -DENABLE_SHIM_CERT
 endif
 OBJS	= shim.o mok.o netboot.o cert.o replacements.o tpm.o version.o errlog.o
-KEYS	= shim_cert.h ocsp.* ca.* shim.crt shim.csr shim.p12 shim.pem shim.key shim.cer
+KEYS    = shim_cert.h ocsp.* ca.* $(INTERNAL_CERT).crt $(INTERNAL_CERT).csr $(INTERNAL_CERT).p12 $(INTERNAL_CERT).pem $(INTERNAL_CERT).key $(INTERNAL_CERT).cer
 ORIG_SOURCES	= shim.c mok.c netboot.c replacements.c tpm.c errlog.c shim.h version.h $(wildcard include/*.h)
 MOK_OBJS = MokManager.o PasswordCrypt.o crypt_blowfish.o
 ORIG_MOK_SOURCES = MokManager.c PasswordCrypt.c crypt_blowfish.c shim.h $(wildcard include/*.h)
@@ -58,14 +59,18 @@ FALLBACK_SRCS = $(foreach source,$(ORIG_
 
 all: $(TARGETS)
 
-shim.crt:
-	$(TOPDIR)/make-certs shim shim@xn--u4h.net all codesign 1.3.6.1.4.1.311.10.3.1 </dev/null
+# certificate is now provided in source.  To generate a random certificate,
+# uncomment this rule
+#$(INTERNAL_CERT).crt:
+#	$(TOPDIR)/make-certs $(INTERNAL_CERT) shim@xn--u4h.net all codesign 1.3.6.1.4.1.311.10.3.1 </dev/null
 
-shim.cer: shim.crt
+$(INTERNAL_CERT).cer: $(INTERNAL_CERT).crt
 	$(OPENSSL) x509 -outform der -in $< -out $@
 
 .NOTPARALLEL: shim_cert.h
-shim_cert.h: shim.cer
+# name "shim_cert.h" rather than "$(INTERNAL_CERT).h" used so C files can just
+# use a fixed name for #include
+shim_cert.h: $(INTERNAL_CERT).cer
 	echo "static UINT8 shim_cert[] __attribute__((__unused__)) = {" > $@
 	$(HEXDUMP) -v -e '1/1 "0x%02x, "' $< >> $@
 	echo "};" >> $@
@@ -76,15 +81,13 @@ version.c : $(TOPDIR)/version.c.in
 		-e "s,@@COMMIT@@,$(COMMIT_ID)," \
 		< $< > $@
 
-certdb/secmod.db: shim.crt
+certdb/secmod.db: $(INTERNAL_CERT).crt
 	-mkdir certdb
-	$(PK12UTIL) -d certdb/ -i shim.p12 -W "" -K ""
-	$(CERTUTIL) -d certdb/ -A -i shim.crt -n shim -t u
+	$(PK12UTIL) -d certdb/ -i $(INTERNAL_CERT).p12 -W "" -K ""
+	$(CERTUTIL) -d certdb/ -A -i $(INTERNAL_CERT).crt -n shim -t u
 
 shim.o: $(SOURCES)
-ifneq ($(origin ENABLE_SHIM_CERT),undefined)
 shim.o: shim_cert.h
-endif
 shim.o: $(wildcard $(TOPDIR)/*.h)
 
 cert.o : $(TOPDIR)/cert.S
@@ -219,8 +222,8 @@ endif
 		$^ $@
 
 ifneq ($(origin ENABLE_SBSIGN),undefined)
-%.efi.signed: %.efi shim.key shim.crt
-	$(SBSIGN) --key shim.key --cert shim.crt --output $@ $<
+%.efi.signed: %.efi $(INTERNAL_CERT).key $(INTERNAL_CERT).crt
+	$(SBSIGN) --key $(INTERNAL_CERT).key --cert $(INTERNAL_CERT).crt --output $@ $<
 else
 %.efi.signed: %.efi certdb/secmod.db
 	$(PESIGN) -n certdb -i $< -c "shim" -s -o $@ -f
@@ -228,9 +231,11 @@ endif
 
 clean-shim-objs:
 	$(MAKE) -C lib -f $(TOPDIR)/lib/Makefile clean
+	@mv $(INTERNAL_CERT).crt $(INTERNAL_CERT).crt.back
 	@rm -rvf $(TARGET) *.o $(SHIM_OBJS) $(MOK_OBJS) $(FALLBACK_OBJS) $(KEYS) certdb $(BOOTCSVNAME)
 	@rm -vf *.debug *.so *.efi *.efi.* *.tar.* version.c buildid
 	@rm -vf Cryptlib/*.[oa] Cryptlib/*/*.[oa]
+	@mv $(INTERNAL_CERT).crt.back $(INTERNAL_CERT).crt
 
 clean: clean-shim-objs
 	$(MAKE) -C Cryptlib -f $(TOPDIR)/Cryptlib/Makefile clean
@@ -263,6 +268,6 @@ archive: tag
 	@rm -rf /tmp/shim-$(VERSION)
 	@echo "The archive is in shim-$(VERSION).tar.bz2"
 
-.PHONY : install-deps shim.key
+.PHONY : install-deps $(INTERNAL_CERT).key
 
 export ARCH CC LD OBJCOPY EFI_INCLUDE
--- /dev/null
+++ a/tis-shim.crt
@@ -0,0 +1,21 @@
+-----BEGIN CERTIFICATE-----
+MIIDXTCCAkWgAwIBAgIJAK2dlnyaByQOMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNV
+BAYTAkNBMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBX
+aWRnaXRzIFB0eSBMdGQwHhcNMTcwMzAxMDEzNTUwWhcNMTgwMzAxMDEzNTUwWjBF
+MQswCQYDVQQGEwJDQTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50
+ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
+CgKCAQEA8XK4jSYD9/WgUu4uZ50fPnRkFZmfK837oCZzgezlORzR38F1frX+3Qjx
+Nohg5uINP8l45mXpEMgD2tzsFGO6pcFpzzKPMAsmPJwODbGYbWr29RCd25h8IGRg
+5RqAjWn2E0vUpweZbo9nVvA1vukSjeUxOoHZmAsTBFWf10HOfTOdQnJ7IcHLPtb7
+bqVPxpexVSwr5lLT8iCzisIVjHJE9G/WqEkhgbYaM8cNa1QmZFJJubHLIqlru73V
+SO2dItQ89LLBi/tb2QXTz+0xhgMlD8tzcYMPeiScSwdO9GURghsqWnltnNB+R/HA
+RKOip1DHRicEgBOhE2s42qBwZP67kwIDAQABo1AwTjAdBgNVHQ4EFgQU4ncd0+jE
+zjXeo8yTEhEZc5kLdMwwHwYDVR0jBBgwFoAU4ncd0+jEzjXeo8yTEhEZc5kLdMww
+DAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAc1WR6lgUM5Onz2eaA/Vt
+AsEnSmjslr5pHP1UuageaLixTmYaqMl7+KiHGmhsZDjME0d3lbjebadp9t4Yjjlf
+Vgx0QcvHHuI/eIFs/femJXDYUrr2JPKMF1quS4MaKiem71pHeouwyAzbzvxS3wh1
+a6ia27kuqvMyq2738kbfjmVQnc0D9etw5kaWouDMUMj5W2awxMbKBFLPmpqMGlku
+Sw4uStDSlmiMrro41Tfkmh57AbYXP7i7bqbz/smnQ6YZdMcFYdlB7k2IePt6DVG+
+/zM2npEBopXi/5MWzmG0xBSEiiy9Yo+mSTh+3RvXtYxBmmwZb7wvJ6Cgp92NuA6B
+Eg==
+-----END CERTIFICATE-----
-- 
1.8.3.1

