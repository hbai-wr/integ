From 2e9caf325a15cd88b8d064ca7f0a9bf2d5eef0cf Mon Sep 17 00:00:00 2001
Message-Id: <2e9caf325a15cd88b8d064ca7f0a9bf2d5eef0cf.1594049324.git.Jim.Somerville@windriver.com>
In-Reply-To: <8a1447370731dd7b2f788ee75d36a3fcf9b76461.1594049323.git.Jim.Somerville@windriver.com>
References: <8a1447370731dd7b2f788ee75d36a3fcf9b76461.1594049323.git.Jim.Somerville@windriver.com>
From: Chris Friesen <chris.friesen@windriver.com>
Date: Wed, 11 Jan 2017 13:38:37 -0500
Subject: [PATCH 15/34] Enable building kernel with CONFIG_BLK_DEV_NBD

By default, the CentOS 7.3 kernel will fail to build if
CONFIG_BLK_DEV_NBD is enabled, either as module or builtin.

The issue seems to be due to the use of REQ_TYPE_SPECIAL in the
NBD code.  Switching it to use REQ_TYPE_DRV_PRIV instead makes the
problem go away.

Signed-off-by: Jim Somerville <Jim.Somerville@windriver.com>
---
 drivers/block/nbd.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/block/nbd.c b/drivers/block/nbd.c
index a40a4f0..e0c6b62 100644
--- a/drivers/block/nbd.c
+++ b/drivers/block/nbd.c
@@ -616,7 +616,7 @@ static int __nbd_ioctl(struct block_device *bdev, struct nbd_device *nbd,
 		fsync_bdev(bdev);
 		mutex_lock(&nbd->tx_lock);
 		blk_rq_init(NULL, &sreq);
-		sreq.cmd_type = REQ_TYPE_SPECIAL;
+		sreq.cmd_type = REQ_TYPE_DRV_PRIV;
 		nbd_cmd(&sreq) = NBD_CMD_DISC;
 
 		/* Check again after getting mutex back.  */
-- 
1.8.3.1

